{"version":3,"sources":["index.js"],"names":["require","Plugin","Socket","Provider","RequestClient","EventTracker","emitSocketProgress","getSocketHost","RateLimitedQueue","Uploader","regeneratorRuntime","assertServerError","res","error","Error","message","module","exports","uppy","opts","divideIntoChunks","arr","chunkSize","minSize","length","chunks","id","lastChunk","push","type","title","client","uploadStartEventsData","defaultOptions","timeout","limit","retryDelays","createMultipartUpload","bind","listParts","prepareUploadPart","abortMultipartUpload","completeMultipartUpload","upload","requests","uploaders","Object","create","uploaderEvents","uploaderSockets","resetUploaderReferences","fileID","abort","really","remove","close","assertHost","method","companionUrl","file","metadata","keys","meta","map","key","toString","post","filename","name","then","uploadId","encodeURIComponent","get","number","parts","uploadIdEnc","delete","uploadFile","Promise","resolve","reject","onStart","data","cFile","getFile","setFileState","s3Multipart","onProgress","bytesUploaded","bytesTotal","emit","uploader","onError","err","log","queuedRequest","done","onSuccess","result","uploadResp","uploadURL","location","onPartComplete","part","getChunkSize","run","isPaused","start","onFileRemove","removed","onCancelAll","onFilePause","pause","onPauseAll","onResumeAll","isRestored","uploadRemote","serverToken","connectToServerSocket","Client","remote","providerOptions","provider","url","body","protocol","size","token","catch","host","socket","target","autoOpen","send","onRetry","isOpen","onRetryAll","on","progressData","errData","open","fileIDs","promises","chunk","chunkPromises","isRemote","setTimeout","eventChunks","eventChunk","all","cb","targetFileID","filesToRetry","install","getState","capabilities","setState","resumableUploads","addUploader","uninstall","removeUploader","VERSION","version"],"mappings":"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","sourcesContent":["const { Plugin } = require('@uppy/core')\nconst { Socket, Provider, RequestClient } = require('@uppy/companion-client')\nconst EventTracker = require('@uppy/utils/lib/EventTracker')\nconst emitSocketProgress = require('@uppy/utils/lib/emitSocketProgress')\nconst getSocketHost = require('@uppy/utils/lib/getSocketHost')\nconst RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue')\nconst Uploader = require('./MultipartUploader')\nconst regeneratorRuntime = require(\"regenerator-runtime/runtime\");\n\nfunction assertServerError (res) {\n  if (res && res.error) {\n    const error = new Error(res.message)\n    Object.assign(error, res.error)\n    throw error\n  }\n  return res\n}\n\nmodule.exports = class AwsS3Multipart extends Plugin {\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'AwsS3Multipart'\n    this.title = 'AWS S3 Multipart'\n    this.client = new RequestClient(uppy, opts)\n    this.uploadStartEventsData = [];\n\n    const defaultOptions = {\n      timeout: 30 * 1000,\n      limit: 0,\n      retryDelays: [0, 1000, 3000, 5000],\n      createMultipartUpload: this.createMultipartUpload.bind(this),\n      listParts: this.listParts.bind(this),\n      prepareUploadPart: this.prepareUploadPart.bind(this),\n      abortMultipartUpload: this.abortMultipartUpload.bind(this),\n      completeMultipartUpload: this.completeMultipartUpload.bind(this)\n    };\n\n    this.opts = { ...defaultOptions, ...opts };\n\n    this.upload = this.upload.bind(this);\n\n    this.requests = new RateLimitedQueue(this.opts.limit, false);\n\n    this.uploaders = Object.create(null);\n    this.uploaderEvents = Object.create(null);\n    this.uploaderSockets = Object.create(null);\n  }\n\n  /**\n   * Clean up all references for a file's upload: the MultipartUploader instance,\n   * any events related to the file, and the Companion WebSocket connection.\n   *\n   * Set `opts.abort` to tell S3 that the multipart upload is cancelled and must be removed.\n   * This should be done when the user cancels the upload, not when the upload is completed or errored.\n   */\n  resetUploaderReferences (fileID, opts = {}) {\n    if (this.uploaders[fileID]) {\n      this.uploaders[fileID].abort({ really: opts.abort || false })\n      this.uploaders[fileID] = null\n    }\n    if (this.uploaderEvents[fileID]) {\n      this.uploaderEvents[fileID].remove()\n      this.uploaderEvents[fileID] = null\n    }\n    if (this.uploaderSockets[fileID]) {\n      this.uploaderSockets[fileID].close()\n      this.uploaderSockets[fileID] = null\n    }\n  }\n\n  assertHost (method) {\n    if (!this.opts.companionUrl) {\n      throw new Error(`Expected a \\`companionUrl\\` option containing a Companion address, or if you are not using Companion, a custom \\`${method}\\` implementation.`)\n    }\n  }\n\n  createMultipartUpload (file) {\n    this.assertHost('createMultipartUpload')\n\n    const metadata = {}\n\n    Object.keys(file.meta).map(key => {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString()\n      }\n    })\n\n    return this.client.post('s3/multipart', {\n      filename: file.name,\n      type: file.type,\n      metadata\n    }).then(assertServerError)\n  }\n\n  listParts (file, { key, uploadId }) {\n    this.assertHost('listParts')\n\n    const filename = encodeURIComponent(key)\n    return this.client.get(`s3/multipart/${uploadId}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  prepareUploadPart (file, { key, uploadId, number }) {\n    this.assertHost('prepareUploadPart')\n\n    const filename = encodeURIComponent(key)\n    return this.client.get(`s3/multipart/${uploadId}/${number}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  completeMultipartUpload (file, { key, uploadId, parts }) {\n    this.assertHost('completeMultipartUpload')\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.client.post(`s3/multipart/${uploadIdEnc}/complete?key=${filename}`, { parts })\n      .then(assertServerError)\n  }\n\n  abortMultipartUpload (file, { key, uploadId }) {\n    this.assertHost('abortMultipartUpload')\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.client.delete(`s3/multipart/${uploadIdEnc}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  uploadFile (file) {\n    return new Promise((resolve, reject) => {\n      const onStart = (data) => {\n        const cFile = this.uppy.getFile(file.id)\n        this.uppy.setFileState(file.id, {\n          s3Multipart: {\n            ...cFile.s3Multipart,\n            key: data.key,\n            uploadId: data.uploadId\n          }\n        })\n      }\n\n      const onProgress = (bytesUploaded, bytesTotal) => {\n        this.uppy.emit('upload-progress', file, {\n          uploader: this,\n          bytesUploaded: bytesUploaded,\n          bytesTotal: bytesTotal\n        })\n      }\n\n      const onError = (err) => {\n        this.uppy.log(err)\n        this.uppy.emit('upload-error', file, err)\n\n        queuedRequest.done()\n        this.resetUploaderReferences(file.id)\n        reject(err)\n      }\n\n      const onSuccess = (result) => {\n        const uploadResp = {\n          uploadURL: result.location\n        }\n\n        queuedRequest.done()\n        this.resetUploaderReferences(file.id)\n\n        this.uppy.emit('upload-success', file, uploadResp)\n\n        if (result.location) {\n          this.uppy.log('Download ' + upload.file.name + ' from ' + result.location)\n        }\n\n        resolve(upload)\n      }\n\n      const onPartComplete = (part) => {\n        const cFile = this.uppy.getFile(file.id)\n        if (!cFile) {\n          return\n        }\n\n        this.uppy.emit('s3-multipart:part-uploaded', cFile, part)\n      }\n\n      const upload = new Uploader(file.data, {\n        // .bind to pass the file object to each handler.\n        createMultipartUpload: this.opts.createMultipartUpload.bind(this, file),\n        listParts: this.opts.listParts.bind(this, file),\n        prepareUploadPart: this.opts.prepareUploadPart.bind(this, file),\n        completeMultipartUpload: this.opts.completeMultipartUpload.bind(this, file),\n        abortMultipartUpload: this.opts.abortMultipartUpload.bind(this, file),\n        getChunkSize: this.opts.getChunkSize ? this.opts.getChunkSize.bind(this) : null,\n\n        onStart,\n        onProgress,\n        onError,\n        onSuccess,\n        onPartComplete,\n\n        limit: this.opts.limit || 5,\n        retryDelays: this.opts.retryDelays || [],\n        ...file.s3Multipart\n      })\n\n      this.uploaders[file.id] = upload\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      let queuedRequest = this.requests.run(() => {\n        if (!file.isPaused) {\n          upload.start()\n        }\n        // Don't do anything here, the caller will take care of cancelling the upload itself\n        // using resetUploaderReferences(). This is because resetUploaderReferences() has to be\n        // called when this request is still in the queue, and has not been started yet, too. At\n        // that point this cancellation function is not going to be called.\n        return () => {}\n      })\n\n      this.onFileRemove(file.id, (removed) => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${removed.id} was removed`)\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          upload.pause()\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            upload.start()\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        upload.pause()\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          upload.abort()\n        }\n        queuedRequest = this.requests.run(() => {\n          upload.start()\n          return () => {}\n        })\n      })\n\n      if (!file.isRestored) {\n        this.uploadStartEventsData.push({file, upload});\n      }\n    })\n  }\n\n  uploadRemote (file) {\n    this.resetUploaderReferences(file.id)\n\n    this.uppy.emit('upload-started', file)\n    if (file.serverToken) {\n      return this.connectToServerSocket(file)\n    }\n\n    return new Promise((resolve, reject) => {\n      const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n      const client = new Client(this.uppy, file.remote.providerOptions)\n      client.post(\n        file.remote.url,\n        {\n          ...file.remote.body,\n          protocol: 's3-multipart',\n          size: file.data.size,\n          metadata: file.meta\n        }\n      ).then((res) => {\n        this.uppy.setFileState(file.id, { serverToken: res.token })\n        file = this.uppy.getFile(file.id)\n        return file\n      }).then((file) => {\n        return this.connectToServerSocket(file)\n      }).then(() => {\n        resolve()\n      }).catch((err) => {\n        this.uppy.emit('upload-error', file, err)\n        reject(err)\n      })\n    })\n  }\n\n  connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      const socket = new Socket({ target: `${host}/api/${token}`, autoOpen: false })\n      this.uploaderSockets[file.id] = socket\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      this.onFileRemove(file.id, (removed) => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          socket.send('pause', {})\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            socket.send('resume', {})\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n        this.resetUploaderReferences(file.id)\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          socket.send('pause', {})\n        }\n        queuedRequest = this.requests.run(() => {\n          socket.send('resume', {})\n        })\n      })\n\n      this.onRetry(file.id, () => {\n        // Only do the retry if the upload is actually in progress;\n        // else we could try to send these messages when the upload is still queued.\n        // We may need a better check for this since the socket may also be closed\n        // for other reasons, like network failures.\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      this.onRetryAll(file.id, () => {\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n      socket.on('error', (errData) => {\n        this.uppy.emit('upload-error', file, new Error(errData.error))\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        reject(new Error(errData.error))\n      })\n\n      socket.on('success', (data) => {\n        const uploadResp = {\n          uploadURL: data.url\n        }\n\n        this.uppy.emit('upload-success', file, uploadResp)\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        resolve()\n      })\n\n      let queuedRequest = this.requests.run(() => {\n        socket.open()\n        if (file.isPaused) {\n          socket.send('pause', {})\n        }\n\n        return () => {}\n      })\n    })\n  }\n\n  divideIntoChunks = (arr, chunkSize = null) => {\n    const minSize = 300;\n    chunkSize = chunkSize ? chunkSize : arr.length / 100;\n    chunkSize = chunkSize < minSize ? minSize : chunkSize;\n    const chunks = [];\n    for (const id of arr) {\n      const lastChunk = chunks.length > 0 ? chunks[chunks.length - 1] : null;\n      if (lastChunk && lastChunk.length < chunkSize) {\n        lastChunk.push(id)\n      } else {\n        chunks.push([id]);\n      }\n    }\n\n    return chunks;\n  }\n\n  async upload (fileIDs) {\n    if (fileIDs.length === 0) return;\n\n    this.uppy.emit('upload-started', null);\n    const chunks = this.divideIntoChunks(fileIDs);\n    const promises = [];\n    for (const chunk of chunks) {\n      const chunkPromises = chunk.map((id) => {\n      var file = this.uppy.getFile(id);\n        if (file.isRemote) {\n          return this.uploadRemote(file);\n        }\n        return this.uploadFile(file);\n      });\n      promises.push(...chunkPromises);\n      await new Promise((resolve) => {setTimeout(() => resolve(), 200)});\n    }\n\n    const eventChunks = this.divideIntoChunks(this.uploadStartEventsData);\n    // Before starting upload send events of all files starting so loading can be generated\n    for (eventChunk of eventChunks) {\n      this.uppy.emit('upload-started', eventChunk);\n      await new Promise((resolve) => {setTimeout(() => resolve(), 400)});\n    }\n\n    this.requests.start();\n    this.uppy.emit('start-event-completed');\n    return Promise.all(promises);\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onFilePause (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-pause', (targetFileID, isPaused) => {\n      if (fileID === targetFileID) {\n        // const isPaused = this.uppy.pauseResume(fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', (filesToRetry) => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onPauseAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('pause-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('cancel-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onResumeAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('resume-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  install () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: true\n      }\n    })\n    this.uppy.addUploader(this.upload)\n  }\n\n  uninstall () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: false\n      }\n    })\n    this.uppy.removeUploader(this.upload)\n  }\n}\n"]}